<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>é›¾é•œ - å®Œæ•´æµç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .test-section h2 {
            margin: 0 0 15px 0;
            color: #4A90E2;
            font-size: 18px;
        }
        
        button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #357ABD;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .result-box {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status {
            padding: 8px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .image-preview {
            max-width: 300px;
            max-height: 200px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #e0e0e0;
            margin: 0 5px;
            border-radius: 5px;
            position: relative;
        }
        
        .step.active {
            background: #4A90E2;
            color: white;
        }
        
        .step.completed {
            background: #28a745;
            color: white;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .upload-btn {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .upload-btn:hover {
            background: #218838;
        }
        
        .keywords-box {
            margin: 10px 0;
        }
        
        .keyword {
            display: inline-block;
            background: #4A90E2;
            color: white;
            padding: 4px 12px;
            margin: 4px;
            border-radius: 15px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§­ é›¾é•œ - å®Œæ•´æµç¨‹æµ‹è¯•</h1>
        <p class="subtitle">æµ‹è¯•å›¾ç‰‡è¯†åˆ« â†’ äº‹å®æå– â†’ è®¤çŸ¥åœ°å›¾çš„å®Œæ•´æµç¨‹</p>
        
        <div class="step-indicator">
            <div class="step" id="step1">1. é€‰æ‹©å›¾ç‰‡</div>
            <div class="step" id="step2">2. å›¾ç‰‡åˆ†æ</div>
            <div class="step" id="step3">3. äº‹å®å¯¹è¯</div>
            <div class="step" id="step4">4. è®¤çŸ¥åœ°å›¾</div>
        </div>
        
        <!-- æ­¥éª¤1ï¼šé€‰æ‹©å›¾ç‰‡ -->
        <div class="test-section">
            <h2>æ­¥éª¤1ï¼šé€‰æ‹©æµ‹è¯•å›¾ç‰‡</h2>
            <label class="upload-btn">
                é€‰æ‹©æœ¬åœ°å›¾ç‰‡
                <input type="file" id="fileInput" accept="image/*" onchange="handleFile(event)">
            </label>
            <button onclick="useTestImage('exhibition')">ä½¿ç”¨å±•è§ˆæµ‹è¯•å›¾</button>
            <button onclick="useTestImage('river')">ä½¿ç”¨æ²³æµæµ‹è¯•å›¾</button>
            <button onclick="useTestImage('document')">ä½¿ç”¨æ–‡æ¡£æµ‹è¯•å›¾</button>
            
            <div id="imagePreview"></div>
        </div>
        
        <!-- æ­¥éª¤2ï¼šå›¾ç‰‡åˆ†æ -->
        <div class="test-section">
            <h2>æ­¥éª¤2ï¼šClaudeè§†è§‰åˆ†æ</h2>
            <button id="analyzeBtn" onclick="analyzeImage()" disabled>å¼€å§‹åˆ†æå›¾ç‰‡</button>
            <div class="status" id="analyzeStatus" style="display:none"></div>
            <div class="result-box" id="analyzeResult" style="display:none"></div>
            <div class="keywords-box" id="imageKeywords" style="display:none"></div>
        </div>
        
        <!-- æ­¥éª¤3ï¼šäº‹å®å¯¹è¯ -->
        <div class="test-section">
            <h2>æ­¥éª¤3ï¼šåŸºäºå›¾ç‰‡çš„äº‹å®è¿½é—®</h2>
            <input type="text" id="userInput" placeholder="å›ç­”AIçš„é—®é¢˜..." style="width: 70%; padding: 10px; margin-right: 10px;">
            <button id="chatBtn" onclick="sendMessage()" disabled>å‘é€</button>
            <div class="result-box" id="chatHistory" style="display:none; height: 200px;"></div>
        </div>
        
        <!-- æ­¥éª¤4ï¼šè®¤çŸ¥åœ°å›¾ -->
        <div class="test-section">
            <h2>æ­¥éª¤4ï¼šæŸ¥çœ‹è®¤çŸ¥åœ°å›¾æ•°æ®</h2>
            <button id="mapBtn" onclick="getCognitiveMap()" disabled>è·å–è®¤çŸ¥åœ°å›¾</button>
            <div class="result-box" id="mapResult" style="display:none"></div>
        </div>
        
        <!-- å®Œæ•´æµ‹è¯• -->
        <div class="test-section" style="background: #e3f2fd;">
            <h2>ğŸš€ ä¸€é”®å®Œæ•´æµ‹è¯•</h2>
            <button onclick="runFullTest()" style="background: #ff5722;">è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•</button>
            <div class="status" id="fullTestStatus" style="display:none"></div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let sessionId = 'test-' + Date.now();
        let currentStep = 1;
        
        function updateStep(step) {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (i < step) {
                    stepEl.className = 'step completed';
                } else if (i === step) {
                    stepEl.className = 'step active';
                } else {
                    stepEl.className = 'step';
                }
            }
            currentStep = step;
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="${e.target.result}" class="image-preview">`;
                document.getElementById('analyzeBtn').disabled = false;
                updateStep(2);
            };
            reader.readAsDataURL(file);
        }
        
        // ä½¿ç”¨æµ‹è¯•å›¾ç‰‡
        function useTestImage(type) {
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 300;
            const ctx = canvas.getContext('2d');
            
            // ç»˜åˆ¶ä¸åŒçš„æµ‹è¯•å›¾
            switch(type) {
                case 'exhibition':
                    // æ¨¡æ‹Ÿå±•è§ˆç…§ç‰‡
                    ctx.fillStyle = '#2a2a2a';
                    ctx.fillRect(0, 0, 400, 300);
                    ctx.fillStyle = '#4a4a4a';
                    ctx.fillRect(50, 50, 120, 90);
                    ctx.fillRect(230, 50, 120, 90);
                    ctx.fillStyle = 'white';
                    ctx.font = '16px Arial';
                    ctx.fillText('Climate Change Exhibition', 100, 250);
                    ctx.font = '12px Arial';
                    ctx.fillText('2024.03.15', 160, 270);
                    break;
                    
                case 'river':
                    // æ¨¡æ‹Ÿæ²³æµç…§ç‰‡
                    ctx.fillStyle = '#87CEEB';
                    ctx.fillRect(0, 0, 400, 150);
                    ctx.fillStyle = '#4a4a4a';
                    ctx.fillRect(0, 150, 400, 150);
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(0, 140, 400, 20);
                    ctx.fillStyle = '#666';
                    ctx.font = '14px Arial';
                    ctx.fillText('Polluted River - 2019', 250, 290);
                    break;
                    
                case 'document':
                    // æ¨¡æ‹Ÿæ–‡æ¡£ç…§ç‰‡
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, 400, 300);
                    ctx.strokeStyle = '#333';
                    ctx.strokeRect(40, 40, 320, 220);
                    ctx.fillStyle = 'black';
                    ctx.font = '20px Arial';
                    ctx.fillText('ç¦»å©šåè®®ä¹¦', 140, 80);
                    ctx.font = '14px Arial';
                    ctx.fillText('æ—¥æœŸï¼š2019å¹´3æœˆ15æ—¥', 50, 120);
                    ctx.fillText('ç”²æ–¹ï¼šå¼ æŸ', 50, 150);
                    ctx.fillText('ä¹™æ–¹ï¼šææŸ', 50, 180);
                    break;
            }
            
            canvas.toBlob((blob) => {
                selectedFile = new File([blob], `test-${type}.png`, { type: 'image/png' });
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="${canvas.toDataURL()}" class="image-preview">`;
                document.getElementById('analyzeBtn').disabled = false;
                updateStep(2);
            });
        }
        
        // åˆ†æå›¾ç‰‡
        async function analyzeImage() {
            if (!selectedFile) return;
            
            updateStep(2);
            const statusEl = document.getElementById('analyzeStatus');
            const resultEl = document.getElementById('analyzeResult');
            const keywordsEl = document.getElementById('imageKeywords');
            
            statusEl.style.display = 'block';
            statusEl.className = 'status info';
            statusEl.textContent = 'æ­£åœ¨åˆ†æå›¾ç‰‡...';
            
            const formData = new FormData();
            formData.append('image', selectedFile);
            
            try {
                const response = await fetch('http://localhost:3001/api/vision/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusEl.className = 'status success';
                    statusEl.textContent = 'âœ… å›¾ç‰‡åˆ†ææˆåŠŸï¼ä½¿ç”¨æ¨¡å‹ï¼š' + data.model;
                    
                    resultEl.style.display = 'block';
                    resultEl.textContent = JSON.stringify(data.analysis, null, 2);
                    
                    // æå–å…³é”®è¯
                    const keywords = extractKeywords(data.analysis);
                    if (keywords.length > 0) {
                        keywordsEl.style.display = 'block';
                        keywordsEl.innerHTML = '<strong>æå–çš„å…³é”®è¯ï¼š</strong><br>' +
                            keywords.map(k => `<span class="keyword">${k}</span>`).join('');
                    }
                    
                    document.getElementById('chatBtn').disabled = false;
                    updateStep(3);
                    
                    // è‡ªåŠ¨å¼€å§‹å¯¹è¯
                    setTimeout(() => startChat(data.analysis), 1000);
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'âŒ åˆ†æå¤±è´¥ï¼š' + data.error;
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message;
            }
        }
        
        // æå–å…³é”®è¯
        function extractKeywords(analysis) {
            const keywords = new Set();
            const text = Object.values(analysis).filter(v => typeof v === 'string').join(' ');
            
            // æ—¶é—´
            const timePatterns = /(\d{4}å¹´|\d{1,2}æœˆ|\d{1,2}[æ—¥å·]|2019|2024)/g;
            const times = text.match(timePatterns);
            if (times) times.forEach(t => keywords.add(t));
            
            // åœ°ç‚¹
            const placePatterns = /(å±•è§ˆ|å±•å…|æ²³æµ|åè®®|æ±¡æŸ“)/g;
            const places = text.match(placePatterns);
            if (places) places.forEach(p => keywords.add(p));
            
            return Array.from(keywords);
        }
        
        // å¼€å§‹å¯¹è¯
        async function startChat(imageAnalysis) {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.style.display = 'block';
            
            // å‘é€å›¾ç‰‡åˆ†æç»“æœåˆ°è®¤çŸ¥åœ°å›¾ç³»ç»Ÿ
            const formData = new FormData();
            formData.append('content', 'æˆ‘æƒ³åˆ†äº«è¿™å¼ å›¾ç‰‡');
            formData.append('sessionId', sessionId);
            formData.append('image', selectedFile);
            formData.append('imageAnalysis', JSON.stringify(imageAnalysis));
            
            try {
                const response = await fetch('http://localhost:3001/api/chat/message', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    chatHistory.innerHTML = `<strong>AI:</strong> ${data.message.content}\n\n`;
                    document.getElementById('mapBtn').disabled = false;
                }
            } catch (error) {
                chatHistory.innerHTML = `<strong>é”™è¯¯:</strong> ${error.message}\n\n`;
            }
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const content = input.value.trim();
            if (!content) return;
            
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML += `<strong>ç”¨æˆ·:</strong> ${content}\n`;
            
            input.value = '';
            
            try {
                const response = await fetch('http://localhost:3001/api/chat/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, sessionId })
                });
                
                const data = await response.json();
                if (data.success) {
                    chatHistory.innerHTML += `<strong>AI:</strong> ${data.message.content}\n\n`;
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    updateStep(4);
                }
            } catch (error) {
                chatHistory.innerHTML += `<strong>é”™è¯¯:</strong> ${error.message}\n\n`;
            }
        }
        
        // è·å–è®¤çŸ¥åœ°å›¾
        async function getCognitiveMap() {
            const resultEl = document.getElementById('mapResult');
            resultEl.style.display = 'block';
            resultEl.textContent = 'è·å–è®¤çŸ¥åœ°å›¾...';
            
            try {
                const response = await fetch(`http://localhost:3001/api/cognitive-map/${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    resultEl.textContent = JSON.stringify(data.cognitiveMap, null, 2);
                    updateStep(4);
                } else {
                    resultEl.textContent = 'è·å–å¤±è´¥ï¼š' + data.error;
                }
            } catch (error) {
                resultEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼š' + error.message;
            }
        }
        
        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            const statusEl = document.getElementById('fullTestStatus');
            statusEl.style.display = 'block';
            statusEl.className = 'status info';
            statusEl.textContent = 'å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...';
            
            // 1. ä½¿ç”¨æµ‹è¯•å›¾ç‰‡
            await new Promise(resolve => {
                useTestImage('exhibition');
                setTimeout(resolve, 1000);
            });
            
            // 2. åˆ†æå›¾ç‰‡
            await analyzeImage();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 3. å‘é€æµ‹è¯•æ¶ˆæ¯
            document.getElementById('userInput').value = 'è¿™æ˜¯2024å¹´3æœˆåœ¨åŒ—äº¬çœ‹çš„å±•è§ˆ';
            await sendMessage();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 4. è·å–è®¤çŸ¥åœ°å›¾
            await getCognitiveMap();
            
            statusEl.className = 'status success';
            statusEl.textContent = 'âœ… å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆï¼';
        }
        
        // æ£€æŸ¥æœåŠ¡å™¨
        async function checkServers() {
            try {
                // æ£€æŸ¥Claudeè§†è§‰æœåŠ¡å™¨
                const visionResponse = await fetch('http://localhost:3001/api/health');
                const visionData = await visionResponse.json();
                console.log('è§†è§‰æœåŠ¡å™¨:', visionData);
                
                if (!visionData.hasApiKey) {
                    alert('è¯·ç¡®ä¿OpenRouter APIå¯†é’¥å·²é…ç½®');
                }
            } catch (error) {
                alert('è¯·å…ˆå¯åŠ¨ vision-claude-server.js');
            }
        }
        
        // åˆå§‹åŒ–
        updateStep(1);
        checkServers();
        
        // å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>