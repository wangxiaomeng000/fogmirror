<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å›¾ç‰‡è¯†åˆ«æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
        }
        
        .upload-area {
            border: 2px dashed #4A90E2;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9fa;
            cursor: pointer;
        }
        
        .upload-area.dragging {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .preview {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .preview-image {
            flex: 1;
        }
        
        .preview-image img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .analysis-result {
            flex: 1;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .analysis-section {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .analysis-section h3 {
            margin: 0 0 10px 0;
            color: #4A90E2;
            font-size: 16px;
        }
        
        .analysis-section p {
            margin: 5px 0;
            color: #666;
            line-height: 1.6;
        }
        
        button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
        }
        
        button:hover {
            background: #357ABD;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.loading {
            background: #cce5ff;
            color: #004085;
        }
        
        .test-images {
            margin: 20px 0;
            text-align: center;
        }
        
        .test-btn {
            background: #28a745;
            font-size: 14px;
            padding: 8px 20px;
            margin: 5px;
            display: inline-block;
        }
        
        .extracted-keywords {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .keyword {
            display: inline-block;
            background: #4A90E2;
            color: white;
            padding: 4px 12px;
            margin: 4px;
            border-radius: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å›¾ç‰‡è¯†åˆ«èƒ½åŠ›æµ‹è¯•</h1>
        
        <div class="status" id="status">å‡†å¤‡å°±ç»ª</div>
        
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <h3>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</h3>
            <p>æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæœ€å¤§ 10MB</p>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFile(event.target.files[0])">
        </div>
        
        <div class="test-images">
            <button class="test-btn" onclick="testWithUrl('exhibition')">æµ‹è¯•å±•è§ˆç…§ç‰‡</button>
            <button class="test-btn" onclick="testWithUrl('river')">æµ‹è¯•æ²³æµç…§ç‰‡</button>
            <button class="test-btn" onclick="testWithUrl('people')">æµ‹è¯•äººç‰©ç…§ç‰‡</button>
            <button class="test-btn" onclick="testWithUrl('document')">æµ‹è¯•æ–‡æ¡£ç…§ç‰‡</button>
        </div>
        
        <div class="preview" id="preview" style="display: none;">
            <div class="preview-image">
                <h3>åŸå§‹å›¾ç‰‡</h3>
                <img id="previewImg" src="" alt="é¢„è§ˆ">
            </div>
            
            <div class="analysis-result">
                <h3>å›¾ç‰‡åˆ†æç»“æœ</h3>
                <div id="analysisContent">
                    åˆ†æä¸­...
                </div>
            </div>
        </div>
        
        <button id="analyzeBtn" onclick="analyzeImage()" disabled>å¼€å§‹åˆ†æ</button>
    </div>

    <script>
        let selectedFile = null;
        
        // æ‹–æ‹½ä¸Šä¼ 
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragging');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragging');
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleFile(file);
            }
        });
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFile(file) {
            if (!file) return;
            
            selectedFile = file;
            const reader = new FileReader();
            
            reader.onload = (e) => {
                document.getElementById('preview').style.display = 'flex';
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('analyzeBtn').disabled = false;
                updateStatus('å·²é€‰æ‹©å›¾ç‰‡ï¼š' + file.name, 'success');
            };
            
            reader.readAsDataURL(file);
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }
        
        // åˆ†æå›¾ç‰‡
        async function analyzeImage() {
            if (!selectedFile) return;
            
            updateStatus('æ­£åœ¨åˆ†æå›¾ç‰‡...', 'loading');
            document.getElementById('analyzeBtn').disabled = true;
            
            const formData = new FormData();
            formData.append('image', selectedFile);
            
            try {
                const response = await fetch('http://localhost:3001/api/vision/test', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayAnalysis(data.analysis);
                    updateStatus('åˆ†æå®Œæˆï¼ä½¿ç”¨æ–¹æ³•ï¼š' + data.method, 'success');
                } else {
                    updateStatus('åˆ†æå¤±è´¥ï¼š' + data.error, 'error');
                }
            } catch (error) {
                updateStatus('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
                console.error('åˆ†æé”™è¯¯:', error);
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
            }
        }
        
        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayAnalysis(analysis) {
            const content = document.getElementById('analysisContent');
            content.innerHTML = '';
            
            // å¦‚æœæ˜¯çº¯æ–‡æœ¬æè¿°
            if (analysis.description && typeof analysis.description === 'string') {
                content.innerHTML = `
                    <div class="analysis-section">
                        <h3>å®Œæ•´æè¿°</h3>
                        <p>${analysis.description}</p>
                    </div>
                `;
                
                // æå–å…³é”®è¯
                const keywords = extractKeywordsFromText(analysis.description);
                if (keywords.length > 0) {
                    content.innerHTML += `
                        <div class="extracted-keywords">
                            <h3>æå–çš„å…³é”®è¯</h3>
                            ${keywords.map(k => `<span class="keyword">${k}</span>`).join('')}
                        </div>
                    `;
                }
                return;
            }
            
            // æ˜¾ç¤ºç»“æ„åŒ–åˆ†æ
            const sections = [
                { key: 'åœºæ™¯æè¿°', title: 'åœºæ™¯ä¸ç¯å¢ƒ' },
                { key: 'äººç‰©ä¿¡æ¯', title: 'äººç‰©è¯¦æƒ…' },
                { key: 'ç‰©å“ç»†èŠ‚', title: 'ç‰©å“ä¸ç»†èŠ‚' },
                { key: 'æ—¶é—´çº¿ç´¢', title: 'æ—¶é—´çº¿ç´¢' },
                { key: 'æ–‡å­—å†…å®¹', title: 'æ–‡å­—ä¿¡æ¯' },
                { key: 'æƒ…ç»ªæ°›å›´', title: 'æƒ…ç»ªä¸æ°›å›´' },
                { key: 'ç‰¹æ®Šç»†èŠ‚', title: 'ç‰¹æ®Šå‘ç°' }
            ];
            
            sections.forEach(section => {
                if (analysis[section.key]) {
                    content.innerHTML += `
                        <div class="analysis-section">
                            <h3>${section.title}</h3>
                            <p>${analysis[section.key]}</p>
                        </div>
                    `;
                }
            });
            
            // æå–æ‰€æœ‰å…³é”®è¯
            const allText = Object.values(analysis).filter(v => typeof v === 'string').join(' ');
            const keywords = extractKeywordsFromText(allText);
            
            if (keywords.length > 0) {
                content.innerHTML += `
                    <div class="extracted-keywords">
                        <h3>æå–çš„äº‹å®å…³é”®è¯</h3>
                        ${keywords.map(k => `<span class="keyword">${k}</span>`).join('')}
                    </div>
                `;
            }
        }
        
        // æå–å…³é”®è¯
        function extractKeywordsFromText(text) {
            const keywords = new Set();
            
            // æ—¶é—´
            const timePatterns = /(\d{4}å¹´|\d{1,2}æœˆ|\d{1,2}[æ—¥å·]|æ—©ä¸Š|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š|å‡Œæ™¨)/g;
            const times = text.match(timePatterns);
            if (times) times.forEach(t => keywords.add(t));
            
            // åœ°ç‚¹
            const placePatterns = /(å±•è§ˆ|å±•å…|æ²³æµ|å…¬å›­|å®¶|å­¦æ ¡|åŒ»é™¢|åŸå¸‚|è¡—é“|æˆ¿é—´)/g;
            const places = text.match(placePatterns);
            if (places) places.forEach(p => keywords.add(p));
            
            // äººç‰©
            const peoplePatterns = /(ä¸€ä¸ªäºº|ä¸¤ä¸ªäºº|å¾ˆå¤šäºº|æœ‹å‹|å®¶äºº|é™Œç”Ÿäºº)/g;
            const people = text.match(peoplePatterns);
            if (people) people.forEach(p => keywords.add(p));
            
            // å…·ä½“ç‰©å“
            const objectPatterns = /(ç…§ç‰‡|ç”»|æ²³æ°´|åƒåœ¾|å»ºç­‘|æ ‘|èŠ±|æ¡Œå­|æ¤…å­)/g;
            const objects = text.match(objectPatterns);
            if (objects) objects.forEach(o => keywords.add(o));
            
            return Array.from(keywords);
        }
        
        // æµ‹è¯•é¢„è®¾å›¾ç‰‡
        async function testWithUrl(type) {
            updateStatus('åŠ è½½æµ‹è¯•å›¾ç‰‡...', 'loading');
            
            // åˆ›å»ºæµ‹è¯•å›¾ç‰‡
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 300;
            const ctx = canvas.getContext('2d');
            
            // æ ¹æ®ç±»å‹ç»˜åˆ¶ä¸åŒçš„æµ‹è¯•å›¾
            switch(type) {
                case 'exhibition':
                    ctx.fillStyle = '#333';
                    ctx.fillRect(0, 0, 400, 300);
                    ctx.fillStyle = '#666';
                    ctx.fillRect(50, 50, 100, 100);
                    ctx.fillRect(250, 50, 100, 100);
                    ctx.fillStyle = 'white';
                    ctx.font = '20px Arial';
                    ctx.fillText('Environmental Exhibition', 100, 250);
                    break;
                case 'river':
                    ctx.fillStyle = '#87CEEB';
                    ctx.fillRect(0, 0, 400, 150);
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(0, 150, 400, 150);
                    ctx.fillStyle = '#228B22';
                    ctx.fillRect(0, 140, 400, 20);
                    break;
                case 'people':
                    ctx.fillStyle = '#FFE4E1';
                    ctx.fillRect(0, 0, 400, 300);
                    ctx.fillStyle = '#8B4513';
                    ctx.beginPath();
                    ctx.arc(200, 100, 40, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'document':
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, 400, 300);
                    ctx.fillStyle = 'black';
                    ctx.font = '16px Arial';
                    ctx.fillText('ç¦»å©šåè®®ä¹¦', 150, 50);
                    ctx.fillText('æ—¥æœŸï¼š2019å¹´3æœˆ15æ—¥', 50, 100);
                    break;
            }
            
            // è½¬æ¢ä¸ºæ–‡ä»¶
            canvas.toBlob((blob) => {
                const file = new File([blob], `test-${type}.png`, { type: 'image/png' });
                handleFile(file);
                setTimeout(() => analyzeImage(), 500);
            });
        }
        
        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServer() {
            try {
                const response = await fetch('http://localhost:3001/api/health');
                const data = await response.json();
                console.log('æœåŠ¡å™¨çŠ¶æ€:', data);
            } catch (error) {
                updateStatus('æœåŠ¡å™¨æœªå¯åŠ¨ï¼Œè¯·å…ˆå¯åŠ¨ vision-test-server.js', 'error');
            }
        }
        
        // åˆå§‹åŒ–
        checkServer();
    </script>
</body>
</html>